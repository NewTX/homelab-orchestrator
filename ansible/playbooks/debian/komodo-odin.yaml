---
- name: Create Debian VM template
  ansible.builtin.import_playbook: '../proxmox/create-vm-template.yaml'
  vars:
    id: 9002
    vm_name: debian-cloudinit-template
    proxmox_hostname: 'pxm-odin'

- name: Import CloudInit VM
  ansible.builtin.import_playbook: '../proxmox/create-cloudinit-vm.yaml'
  vars:
    vm_name: komodo-odin
    template_name: debian-cloudinit-template
    mac_address: bc:24:11:de:0b:d9
    cores: 14
    memory: 30480
    disk_size: 212G
    storage_name: nvme
    proxmox_hostname: 'pxm-odin'

- name: Start VM
  ansible.builtin.import_playbook: '../proxmox/start-vm.yaml'
  vars:
    vm_name: komodo-odin
    proxmox_hostname: 'pxm-odin'

- name: Playbook to Install Post Configuration
  hosts: komodo-odin.vikaspogu.internal
  gather_facts: false
  vars_files:
    - ../../vars/common.vault.yaml
  tasks:
    - name: Wait 600 seconds for target connection to become reachable/usable
      ansible.builtin.wait_for_connection:
        delay: 5
        timeout: 600

    - name: Wait for cloud init to finish
      community.general.cloud_init_data_facts:
        filter: status
      register: res
      until: 'res.cloud_init_data_facts.status.v1.stage is defined and not res.cloud_init_data_facts.status.v1.stage'
      retries: 50
      delay: 5

    - name: Run as root user
      become: true
      block:
        - name: Set a hostname
          ansible.builtin.hostname:
            name: '{{inventory_hostname}}'

        - name: Install required packages
          ansible.builtin.apt:
            name:
              - qemu-guest-agent
              - git
              - wget
              - unzip
              - tar
              - rsync
              - python3
              - python3-pip
              - apt-transport-https
              - ca-certificates
              - curl
              - software-properties-common
              - virtualenv

        - name: Add Docker GPG apt Key
          ansible.builtin.apt_key:
            url: https://download.docker.com/linux/debian/gpg
            state: present

        - name: Add Docker Repository
          ansible.builtin.apt_repository:
            repo: deb https://download.docker.com/linux/debian bookworm stable
            state: present

        - name: Update apt and install Docker packages
          ansible.builtin.apt:
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-compose
            state: latest
            update_cache: true

        - name: Add user to the Docker group
          ansible.builtin.user:
            name: '{{ansible_user}}'
            groups: docker

        - name: Update apt repo and cache on all Debian/Ubuntu boxes
          ansible.builtin.apt:
            update_cache: true
            force_apt_get: true
            cache_valid_time: 3600

        - name: Upgrade all packages on servers
          ansible.builtin.apt:
            upgrade: dist
            force_apt_get: true

        - name: Check if a reboot is needed on all servers
          register: reboot_required_file
          ansible.builtin.stat:
            path: /var/run/reboot-required
            get_md5: false

        - name: Reboot the box if kernel updated
          ansible.builtin.reboot:
            msg: 'Reboot initiated by Ansible for kernel updates'
            connect_timeout: 5
            reboot_timeout: 300
            pre_reboot_delay: 0
            post_reboot_delay: 30
            test_command: uptime
          when: reboot_required_file.stat.exists

        - name: Enable a timer unit for dnf-automatic
          ansible.builtin.systemd_service:
            name: qemu-guest-agent
            state: started
            enabled: true

    - name: Create a directory to store the komodo files
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/komodo
        state: directory

    - name: Template a file for the komodo-compose.yaml file
      ansible.builtin.template:
        src: '../../templates/komodo-compose.yaml.j2'
        dest: /home/{{ ansible_user }}/komodo/compose.yaml

    - name: Docker compose up
      ansible.builtin.command: docker-compose up -d
      args:
        chdir: /home/{{ ansible_user }}/komodo
